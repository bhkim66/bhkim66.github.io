# ELB

`ELB`는 둘 이상의 가용 영역에서 EC2 인스턴스, 컨테이너, IP 주소 등 여러 대상에 걸쳐 수신되는 트래픽을 자동으로 분산시켜 주는 역할을 한다

등록된 대상의 상태를 모니터링하면서 상태가 양호한 대상으로만 트래픽을 라우팅한다

- 다수의 EC2에 트래픽을 분산 시켜주는 서비스
- `Health Check`: 직접 트래픽을 발생시켜 인스턴스가 살아있는지 체크
- `Autoscaling` 과 연동 가능
- 지속적으로 IP 주소가 바뀌며 IP 고정 불가능: **항상 도메인 기반**으로 사용 → *NLB는 IP 고정 가능*

### ALB (Application Load balancer)

- **OSI Model Layer 7 사용**
- 트래픽을 모니터링 하여 라우팅 가능
- **고가용성 지원**

### NLB (Network Load Balancer)

- **빠른 속도**
- **OSI Model Layer 4**
- TCP, UDP 기반 빠른 트래픽 분산
- Elastic IP 할당 가능(IP 고정 가능)

### CLB (Classic Load Balancer)

- 옛날에 사용되던 타입으로 헌재는 잘 사용하지 않음

### GLB (Gateway Load Balaner)

- 먼저 트래픽을 체크함
- OSI Layer 3
- 가상 어플라이언스 배포/확장 관리를 위한 서비스

### ELB + Auto Scaling

- `Auto Scailing`을 통해 EC2 인스턴스 숫자를 관리하고 `ELB`를 통해 분산 트래픽 처리
- `Auto Scailing`의 인스턴스 증감과 같이 `ELB`에 연결

### 클라우드 환경에서 컴퓨팅 자원 활용

- 온프레미스 환경에선 각 서버를 반영구적으로 사용
- vs 클라우드 환경에서는 각 인스턴스는 소모품이다
    - 예고없이 장애가 발생하거나 통제된 방법으로 종료되는 것이 정상
- 따라서 `stateless`하며 `고가용성`의 확보가 필요
    - **고가용성**: 인스턴스 중 하나가 떨어져도 자동으로 복구 가능한 정도, 프로그램이 정상적으로 사용 가능한 정도를 의미한다
    - **Stateless**: 인스턴스가 상태에 의존적이지 않음
        - **어떤 인스턴스도 특정 정보를 특별하게 저장하지 않음**

![image.png](/assets/img/chapter2/aws/aws_3_1.png)

## Auto Scaling

어플리케이션을 **모니터링하고 용량을 자동으로 조정**하여, 최대한 저렴한 비용으로 안정적이고 예측 가능한 성능을 유지한다

### Scale Up

- 서버의 사양을 업그레이드 시켜 시스템을 확장시키는 것
- 많은 비용이 발생한다
- 수직 스케일로 불린다

### Scale Out

- 서버를 여러 대 추가하여 시스템을 확장하는 것을 말한다 (클라우드 서비스의 기본 철칙)
- 서버가 여러 대로 나뉘기 때문에 각 서버는 `로드밸런싱`이 필수적으로 동반되어야 한다
- 시스템을 나눠 확장하기 때문에 수평 스케일로도 불린다

### 정확한 수의 EC2 인스턴스를 보유하도록 보장

- 그룹의 최소 인스턴스 숫자 및 최대 인스턴스 숫자
    - 최소, 최대 숫자를 넘어가지 않도록 인스턴스 숫자를 유지(인스턴스 추가, 삭제)

### 다양한 스케일링 정책 적용

- **다양한 스케일링 정책**
    - CPU의 부하에 따라 인스턴스 크기 늘리기
    - 특정 시간에 인스턴스 개수 늘리고 다른 시간에 줄이기
- **가용 영역에 인스턴스가 골고루 분산될 수 있도록 인스턴스를 분배**

**분류**

- **수동 스케일**: 수동으로 직접 인스턴스 숫자를 증감
- **스케줄 기반 스케일**: 특정 시점에 인스턴스 숫자를 증감
    - **주로 예측 가능한 시점**의 부하 처리 목적으로 활용
- **동적 스케일**: **특정 기준을 두고 기준치에 따라** 인스턴스 숫자를 증감
    - 예: CPU 사용률 기반, 요청 숫자 기반, 판매량 기반 등
- **예측기반 스케일**: 과거의 기록의 패턴을 기반으로 수요량을 예측해서 인스턴스 숫자를 증감

### 수동 스케일

- 수동으로 인스턴스 숫자를 조절하는 방법
    - 주로 개발 환경 혹은 다른 정책을 적용하기 전 사전 테스트 용도로 활용
- 되도록이면 다른 스케일 정책을 비활성화 시킨 후 적용 추천

### 스케줄 기반 스케일링

- 예측 가능한 시점의 **변동사항에 대비해서 인스턴스 숫자를 조절하는 방식**
    - 예: 매주 수요일마다 주간 이벤트가 있는 게임의 경우
    - 예: 매일 새벽 특정 시간에 하루동안 모인 데이터를 분석
- 적용 방식
    - 특정 시점을 정해서 해당 시점 or Cron으로 표현하는 반복 시점에
    - 범위 지정 (Min, Max, Desired(원하는 인스턴스 수) 셋 중 최소 한가지)
        - 지정 범위보다 인스턴스가 작다면 Scale Out
        - 지정 범위보다 인스턴스가 크다면 Scale In

![image.png](/assets/img/chapter2/aws/aws_3_2.png)

### 동적 스케일

- 지표에 반응해서 인스턴스 숫자를 조절하는 방식
    - 주로 `CloudWatch`의 지표 활용
    - 혹은 자신만의 기준으로 스케일링 정책 조절 가능
- 주로 `Autoscale`에서 지원하는 추적 조정 정책(Target Tracking Policy) 활용
    - 내부적으로 `CloudWatch` 경보(`Alarm`)을 생성해서 경보에 반응하여 자동으로 증감
        - 경보: `CloudWatch` 지표에 반응하여 트리거되는 이벤트
    - 지표 증감에 따라 얼마나 민감하게 반응할 것인지 결정 가능
- 커스텀으로 `Autoscale`의 증감을 수동으로 조절 가능

### 예측기반 스케일

- 사용 패턴을 히스토리 기반으로 예측하여 인스턴스 숫자를 조절하는 방식
    - 주로 반복되는 패턴이 명확하거나, 인스턴스 준비가 오래 걸리는 경우 사용
    - 충분한 데이터가 있어야 사용 가능

### Health Check

- **인스턴스의 상태를 체크하는 기능**
- 상태 확인 소스
    - **EC2**: 인스턴스가 실행중인지, 하드웨어 상태가 정상적인지 확인
    - **ELB**: 트래픽을 발생시켜서 해당 트래픽을 잘 수행하는지 확인
    - **커스텀**: 직접 커스텀 로직으로 상태를 확인
- 상태 확인에 실패했을 때 `Unhealthy` 상태로 변경 → `Autoscale`에서 직접 해당 인스턴스를 교체

### 인스턴스 Warm Up / Health Check Grace Period

- **인스턴스 Warm Up**
    - 인스턴스에 대한 `CloudWatch`의 모니터링 지표가 수집 되기 전 준비 기간
    - 트래픽을 받기 전에 지표등이 반영되지 않도록 설정 가능
- **Health Check Grace Period**
    - 신규로 추가된 인스턴스가 `Health Check`을 수행 하기 전 준비를 위한 기간
        - 기본 300초
    - **인스턴스가 신규로 올라간 이후 준비가 오래 필요할 경우** 등에 활용

### 시작 구성/시작 템플릿

- EC2 유형, 크기
- AMI, 보안 그룹, Key, IAM 역할
- 유저 데이터(EC2 실행 시 실행할 자동 스크립트)
- 기타 설정

### 모니터링 + 상태 확인

- **CPU 점유율이 일정 % 넘어갔을 때** 추가로 실행
- 2개 이상 필요한 스택에서 하나가 죽었을 때
- `CloudWatch` `ELB`와 연계

### 기타 설정

- 종료 정책 : 인스턴스 숫자를 줄일 경우(Scale-in) 어떤 순서로 인스턴스를 종료시킬지에 관한 정책
    - 기본:
        - 인스턴스가 2개 이상인 가용영역의 인스턴스에서
        - 가장 오래된 시작 템플릿
        - 같이 시작한 템플릿이라면 다음 과금 시간에 가장 가까운 인스턴스 종료
    - 커스텀도 가능
    - Lambda를 활용해서 커스텀 정책 적용 가능

## 대상 그룹

- `ELB`가 라우팅 할 대상의 집합
- 구성
    - 대상 종류
        - `Instance`
        - `IP` - private IP 만 가능
        - `Lambda`
        - `ALB` (ELB끼리 조합 가능)
    - 프로토콜(HTTP, HTTPS, gRPC, TCP등)
    - 기타 설정
        - 트래픽 분산 알고리즘, 고정 세션 등

  ![image.png](/assets/img/chapter2/aws/aws_3_3.png)


### 리스너

- ALB로 들어오는 요청을 처리하는 주체
    - 들어오는 트래픽의  프로토콜 + 포트 단위
- 규칙(Rule)으로 ALB에서 어떤 요청을 받을지, 요청을 어떻게 어디로 처리 할지 결정
    - ex) http 8080포트로 트래픽을 받아서 A 대상 그룹의 80번 포트로 배분
        - https 프로토콜(443) 포트로 트래픽을 받아 B 대상그룹의 80번 포트로 배분
- 규칙을 활용해 다양한 조건에 따라 트래픽 배분 가능
    - 활용 가능한 조건 : Header, QueryString, source Ip, Method 등
- 들어온 트래픽 처리 방식
    - forward, redirect, fixed-response, cognito 인증 등