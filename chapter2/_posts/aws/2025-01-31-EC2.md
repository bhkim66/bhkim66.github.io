# EC2

EC2는 안전하고 크기 조정이 가능한 컴퓨팅 파워를 **클라우드에서 제공하는 웹 서비스**이다

- **초 단위 온디맨드 가격 모델**
    - 온디맨드 모델에서는 가격이 초 단위로 결정
    - 서비스 요금을 미리 약정하거나 선입금이 필요 없다
- **빠른 구축 속도와 확장성**
    - 몇 분이면 전 세계에 인스턴스 수백여대를 구축 가능


## 인스턴스

### EC2 인스턴스

- EC2에서 컴퓨팅을 담당
    - 다양한 유형과 크기로 구성
    - 저장을 담당하는 EBS와 네트워크로 연결
- 저장 방법에 따라 두 가지로 분류
    - `EBS 연동`
        - 네트워크로 연결
            - 네트워크 대역폭에 따라 속도가 느려질 수도 있다. 하지만 따로 존재하기 때문에 인스턴스가 사라진다고 해서 EBS는 사라지지 않음
    - `인스턴스 스토어`
        - 내부에 존재하기 때문에 물리적으로 연결되어있어 속도가 매우 빠르다. 하지만 인스턴스가 사라지면 같이 사라지는 단점이 존재
- **하나의 가용영역(AZ)에 존재**


### 인스턴스 유형(패밀리)

- 인스턴스의 역할에 따라 `CPU`, `메모리`, `스토리지`, `네트워크`등을 조합한 구성
- 각 인스턴스 유형 별로 사용 목적에 따라 최적화
    - `메모리` 위주, `CPU` 위주, `그래픽 카드` 위주
- **유형 별로 이름 존재**
    - 예 : `t유형`, `m유형`, `inf유형` 등
    - 같은 유형의 인스턴스들을 인스턴스 패밀리라 부름
- 타입 별 세대별로 숫자 부여
    - 예: m5 = m인스턴스의 5번째 세대
- 아키텍쳐 및 프로세서/추가기술에 따라 접미사
    - c7gn = c 인스턴스 중 AWS Graviton 프로세서를 사용(g) + Network Optimized(n)


- t는 테스트용 m이 평균적으로 많이 사용된다

## EBS

- 가상 하드드라이브
- **EC2 인스턴스가 종료 되어도 계속 유지 가능**
    - `루트 볼륨`으로 사용시 EC2가 종료되면 같이 삭제됨
    - 단 설정을 통해 EBS만 따로 존속 가능
- 용량을 범위에 따라 자유롭게 설정 가능
- 특수하게 하나의 EBS를 여러 EC2 장착 가능한 경우도 있으니 **한개의 `EC2` 한개의 `EBS`가 일반적이다**
- **EC2 인스턴스와 같은 가용영역에 존재**
    - 가용영역안에 자동으로 분산 저장: 99.999% 가용성 목표

### EBS의 유형

- 범용 ( GENERAL Purpose of GP) : SSD
- 프로비저닝된 IOPS (Provisioned IOPS) : SSD → 빠른 속도
- 쓰루풋 최적화 (Throughput Optimized HDD) : HDD → 많은 양 수용
- 콜드 HDD : HDD → 백업용
- 마그네특 : HDD → 백업용

### Snapshot

- **스냅샷** : EBS의 특정 시점을 저장한 이미지
    - 이후 EBS로 다시 복구 가능
    - EBS의 백업 용도로 활용 가능
- **증분식** : 바뀐 부분 만 저장
    - 즉 100GB에서 1GB만 바뀐다고 하면 1GB 바뀐 부분만 저장
    - 비용 최적화 되어있기 때문에 잦은 스냅샷을 추천
- **S3에 저장** : 99.999999999% 내구성
- Data Lifecycle Manager / AWS Backup 등으로 자동화 해서 생성 가능
- **암호화**
- **아카이브** : 더 적은 비용으로 저장할 수 있으니 몇 가지 제약 사항 적용
    - 최소 90일 이상 저장
    - 복원에 최대 72시간 소요

## AMI

- `EC2 인스턴스`를 실행하기 위해 필요한 정보를 모은 템플릿
- 구성
    - 1개 이상의 `EBS 스냅샷`
    - 사용 권한(어떤 AWS 어카운트가 사용할 수 있는지)
    - 블록 디파이스 맵핑(EC2 인스턴스를 위한 볼륨 정보 = EBS가 무슨 용량으로 몇 개 붙는지)
- 필요에 따라 `Private`으로 가지고 있거나 `Public` 공개 가능

### 인스턴스 저장 유형에 따른 AMI의 생성 방법

- `EBS`: 스냅샷을 기반으로 루트 디바이스 생성
- `인스턴스 저장`: S3에 저장된 템플릿을 기반을 생성

### 보안 그룹

- EC2의 **방화벽 역할**을 하는 서비스
- `Port 허용`
    - 기본적으로 모든 포트는 비활성화
    - 선택적으로 트래픽이 지나갈 수 있는 Port와 Source를 설정 가능
    - Deny는 불가능
- 인스턴스 단위
    - 하나의 인스턴스에 **하나 이상의 보안 그룹 설정 가능**
    - 인스턴스에 여러 보안 그룹이 적용될 경우 모든 보안 그룹의 규칙을 적용 받는다

### Public IP, Private Ip

**Public IP**

- 네트워크 외부와 통신하는데 사용되는 IP 주소이다
- `Public IP` 주소는 ISP(Internet service Provider)에서 할당하고, 외부에 공개되어 있는 IP 주소이다
- 전 세계에서 유일한 IP를 가지고, 외부에 공개되어 있기 때문에 인터넷에 연결된 다른 PC에서 또한 접속이 가능하다

**Private IP**

- 동일한 네트워크 내에서 사용되는 IP주소이다
- 일반적으로 사내 등에서 할당된 네트워크 주소이다, IP 부족으로 **서브넷팅된 IP**이기 때문에 라우터에 의해 **로컬 네트워크 상의 PC나 장치에 할당**된다

## EC2 생명 주기

- **중지(Stopped)**
    - 중지 중에는 인스턴스 요금 미 청구
    - 단 EBS, 다른 구성요소은 청구
    - 중지 후 재시작시 퍼블릭 IP 변경
    - 재부팅시에는 퍼블릭 IP 변동 없다


## ENI

- EC2의 가상의 랜카드
- `IP주소`와 `MAC 주소`를 보유
- 하나의 인스턴스에 여러개의 ENI를 연동 가능
    - 하나의 인스턴스가 한 개 이상의 아이피를 보유 가능(특수한 경우)
- 인스턴스 유형 및 사이즈에 따라 최대 보유 가능한 IP주소가 변동
- 내부적으로 보안 그룹은 ENI에 부착 (보안 그룹 하나당 ENI 한개)
- 기본적으로 Private IP 주소와 Private 도메인 보유

### Elastic IP (탄력적 IP)

- EC2의 `퍼블릭 IP`를 **고정해주는 서비스**
    - 즉 인스턴스를 중지 → 재시작 해도 고정적인 IP를 확보 가능
- EC2외 다른 서비스에서도 사용
- 내가 보유한 IP 주소를 AWS에서 사용 가능
- 리전 단위
- **연결하지 않아도 비용 발생**

### EC2 User Data

- EC2 인스턴스의 **최초 실행 시** 지정한 스크립트 실행 가능
    - 별도 설정을 통해서 재부팅 마다 실행하도록 설정 가능
- 두 가지 모드
    - Shell Script
    - cloud-init: 리눅스 이미지와 부트스트래핑을 위한 오픈소스 어플리케이션
- 주요 사용 사례
    - EC2 인스턴스 설정(보안 설정, 인스턴스 설정)
    - 외부 패키지 다운로드
    - 설치 어플리케이션 실행

### Metadata

인스턴스 메타데이터는 실행 중인 인스턴스를 구성 또는 관리하는데 사용될 수 있는 인스턴스 관련 데이터이다

- EC2 인스턴스의 속성 및 정보 데이터
    - AMI ID, IPv4/IPv6주소, EBS 맵핑, 보안 그룹 연동상항, IAM 역할 연동 등
- 실행중인 EC2 인스턴스의 메타데이터 IMDS로 조회 가능
    - **HTTP Endpoint 지원**
    - IP주소 : `169.254.169.254`
    - 두 가지 모드
        - IMDS v1: Request/Response 기반
            - 별도 보안 인증이 필요없음 → *보안에 취약*
        - IMDS v2: 세션 기반(default)
            - 보안 `토큰`을 발급 받아 요청할 때 마다 `토큰`을 사용해 인증하는 세션 방식
                - 토큰의 유효 기간은 1초에서 최대 6시간

                ```bash
                - TOKEN=`curl -X PUT “http://169.254.169.254/latest/api/token” -H” X-aws-ec2-metadata-token-ttl-seconds: 21600`”
                - curl -H “X-aws-ec2-metadata-token: $TOKEN” -v http://169.254.169.254/latest/meta-data/tags/instance/Name
                ```

            - **Amazon EC2 Instance Metadata (고급 설정에 있음)**
                - EC2 실행 시 메타데이터 액세스 가능 여부 설정 가능
                    - 기본 활성화
                    - 버전 선택 가능
                - 가격: 무료
                - 참고로 Tag 조회의 경우 별도로 활성화 해야 Metadata로 Tag 조회 가능

## EC2에 권한 부여

### IAM 자격 증명을 등록

- `IAM` 사용자를 생성하고 `IAM` 자격증명을 발급받아 EC2에 등록
- AWS Configure를 통해 자격 증명을 파일로 등록(~/.aws/credentials)
- 관리가 어렵고 바꾸기 힘들다
    - (100대의 자격 증명을 교체하려면)



### IAM 역할을 부여

- 권한이 부여된 `IAM` 역할을 만들고 EC2에 부여
- **관리가 쉽고 교체가 쉬움**
- 내부적으로 지속적으로 자격 증명을 변경 가능

참고 - 인프런 / 쉽게 설명하는 AWS 기초 강의